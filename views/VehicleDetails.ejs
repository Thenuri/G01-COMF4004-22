<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vehicle Details page</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="/css/syntax1.css">
    <link rel="stylesheet" type="text/css" href="/css/commonstyles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body>
    <div>
        <header>
            <!--nav bar-->
            <nav class="navbar fixed-top navbar-expand-lg navbar-dark p-md-3">
                <div class="container">
                    <a href="/" class="navbar-brand text-white fs-1 fw-bold">Book My Bus</a>
                    <button type="button"class="navbar-toggler"data-bs-target="#navbarNav"data-bs-toggle="collapse"aria-controls="navbarNav"aria-expanded="false"aria-label="Toggle Navbar">
                        <span class="navbar-toggler-icon"></span>
                    </button>
                    <div class="collapse navbar-collapse" id="navbarNav">
                        <div class="mx-auto"></div>
                        <ul class="navbar-nav   fs-5">
                            <li class="nav-item mx-4 my-auto"><a href="/" class="nav-link text-white">Book Now</a></li>
                            <li class="nav-item mx-4 my-auto"><a href="/#aboutUs" class="nav-link text-white">About Us</a></li>
                            <li class="nav-item mx-4 my-auto"><a href="/#ContactUs" class="nav-link text-white">Contact Us</a></li>
                            <%- include('partials/navBarProfileOrSignIn')  %>
                        </ul>
                    </div>
                </div>
            </nav>
            <!--main image-->
            <div class="banner1 vw-100 vh-80   justify-content-center align-items-center">
                <div class="content text-right ">
                    <h1 class="text-white" id="h1text2">Vehicle Details</h1>
                </div>
            </div>
        </header>
    </div>
    <br><br><br>
    <div class="container " style="background-color: #bbc4de; border-radius: 20px; margin-top: 1rem; height:200%; width:60%;">
        <div class="row ">
            <div class="col-sm">
                <img src="/images/jonathan-borba-T5jzpRTVF1U-unsplash.jpg" class="bus-img">
            </div>
            <div class="col-sm fw-bold" id="card-con" ><br>
                <% 
                    let ratingStarsHTML ="";
                    for (let i = 0; i < 5; i++) {

                        if ( i < Math.floor(busDetails.Rating)) {
                            ratingStarsHTML += `<span class="fa fa-star"></span>`
                        } else  {
                            ratingStarsHTML += `<span class="fa fa-star-o"></span>`
                        }
                    }
                %>
                <%= busDetails.Bus_No %> <br><br>
                <div class=" rating-stars d-flex">
                    <%- ratingStarsHTML %> <br>  <%= busDetails.Rating.toFixed(1) %> / 5.0 (<%= busDetails.No_Of_Ratings %>)
                </div><br>
                <br>LKR/KM-LKR <%= busDetails.Price_Per_km %><br><br>
                <img src="/images/ic_airline_seat_recline_extra_24px.svg" class="seat-icon"><span><%= busDetails.No_Of_Seats %></span> <br><br>
                <span><%= busDetails.AC_Status.toUpperCase() %></span>
            </div>
            <div class="col-sm fw-bold" id="card-con1"><br>
                <span>Bus Owner Name<br><%= busDetails.Owner_Name%></span><br><br>
                <span>Driver Name <br><%= busDetails.Driver_Name %></span><br><br>
                <span>Contact Number<br><%= busDetails.Contact_No %></span><br>
            </div>
        </div>                    
    </div>
    <div class="form-container2">
        <form action="" id="bookNowForm">
    <% if (busDetails.Bus_Availability === "available") { %>
       
            <div class="input-box">
                <span>To</span>
                <input type="search" name="" id="to" placeholder="search place">
            </div>
            <div class="input-box">
                <span>From</span>
                <input type="search" name="" id="from" placeholder="search place">
            </div>
            <div class="input-box">
                <span>Start Date</span>
                <input type="date" name="" id="startDate">
            </div>
            <div class="input-box">
                <span>Return Date</span>
                <input type="date" name="" id="returnDate">

            </div>
            
            <button class="btn" id="bookNowBtn">Book Now</button>
           
    <% } else { %>
    <div class="bg-white rounded p-3">
        <div class="text-danger fs-5 fw-bold"> The Bus is unavailable for booking.</div>
    </div>
    <% } %>
    </form>
        
    </div>
    <br><br><br><br><br><br><br><br>

    
    <footer>
        <p class="copyright">
             &copy;  2022 Book My Bus. 
        </p>
    </footer>
    


    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js" integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js" integrity="sha384-cVKIPhGWiC2Al4u+LWgxfKTRIcfu0JTxR+EQDz/bgldoEyl4H0zUF0QKbrJ0EcQF" crossorigin="anonymous"></script>

    <script>
        let navbar = document.querySelector('nav');
        window.addEventListener('scroll',scroll)

        function scroll(){
            if(window.pageYOffset>100){
            //   navbar.classList.add('bg-primary','shadow');  
              navbar.classList.add('bg-dark-blue-theme','shadow');  

            }else{
                navbar.classList.remove('bg-dark-blue-theme','shadow');
            }
        }

    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <script>
        // booking the trip
    let bookNowForm = document.getElementById("bookNowForm");
    bookNowForm.addEventListener("submit", bookBus );
    document.getElementById('startDate').addEventListener("change", setReturnDateMin )
    function bookBus(evt) {
        evt.preventDefault();
        // get the bus id 
        let path = window.location.pathname
        let busId = path.split("/")[2]    // path.split("/") will give u [ "", "vehicle", "1" ]

        let from = document.getElementById("from").value;
        let to = document.getElementById("to").value;
        let startDate = document.getElementById("startDate").value;
        let returnDate = document.getElementById("returnDate").value;

        if ( from === "" || to === "") {
        return alert("Please fill the locations")
        }

        if ( startDate === "" || returnDate === "") {
        return alert("Please add the dates")
        }

        bookingData = {
            busId: busId,
            from: from,
            to: to,
            startDate: startDate,
            returnDate: returnDate,
            startTime: "14:08:48"   // TODO remove hard coded time
        }

      


        // axios post
        // url path
        const urlPath = `/booking/new`

        // For redirect param
        const params = new URLSearchParams(window.location.search);
        const redirectURL = params.get("redirect")
        let url;
        if (redirectURL) {
            url =`${urlPath}?redirect=${redirectURL}`;
        } else {
            url = `${urlPath}`;
        }

        axios.post(url,bookingData)
        .then( (res) => {

            axiosReqUrl = window.location.origin + res.config.url  // url axios sent the request to

            //  if the url axios sent the request and the respose url from the server doesnt match a redirection has occured
            if(axiosReqUrl !== res.request.responseURL) {
                window.location.href = res.request.responseURL;  // set the window location to redirect
            }

            if (res.data.message) {
                alert(res.data.message);
            }

        })
        .catch(e=> {
            console.log(e)
            if(e.response.data.error.message) {
                alert(e.response.data.error.message);
            }
            
        })

    }
    function setReturnDateMin(event) {
        let startDate = event.target.value;
        // set the min of return date to the start date
        document.getElementById('returnDate').setAttribute('min', startDate);
    }

    function validate(bookingData) {



    }

    // Blocking the previous days
    document.addEventListener("DOMContentLoaded", olddate)
    function olddate(){
        let startDate = document.getElementById("startDate").value;
        let returnDate = document.getElementById("returnDate").value;

        let today = new Date().toISOString().split("T")[0];
        document.getElementById('startDate').setAttribute('min', today);
        document.getElementById('returnDate').setAttribute('min', today);
    }

    
        
    </script>

</body>
</html>
